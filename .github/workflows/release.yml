name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  linux:
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            target_gnu: x86_64-unknown-linux-gnu
            target_musl: x86_64-unknown-linux-musl
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies (Linux)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libdbus-1-dev \
            pkg-config \
            libx11-dev \
            libxext-dev \
            libxinerama-dev \
            libxcursor-dev \
            libxrender-dev \
            libxfixes-dev \
            libxft-dev \
            libfontconfig1-dev \
            libpango1.0-dev \
            libcairo2-dev \
            libglib2.0-dev \
            musl-tools \
            patchelf \
            desktop-file-utils \
            zstd \
            fakeroot \
            libfuse2 \
            zip

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target_gnu }},${{ matrix.target_musl }}

      - name: Install packaging tools (Linux)
        run: |
          cargo install cargo-deb --locked
          cargo install cargo-generate-rpm --locked

      - name: Build release (CLI, musl, static)
        run: cargo build --release --no-default-features --target ${{ matrix.target_musl }}

      - name: Build release (GUI, glibc)
        run: cargo build --release --target ${{ matrix.target_gnu }}

      - name: Package (Linux)
        shell: bash
        run: |
          mkdir -p dist

          CLI_BIN="target/${{ matrix.target_musl }}/release/fontsync"
          GUI_BIN="target/${{ matrix.target_gnu }}/release/fontsync"

          cp "$CLI_BIN" dist/fontsync-server
          zip -j dist/fontsync-linux-server-${{ matrix.arch }}.zip dist/fontsync-server

          # deb
          cargo deb --no-build --target ${{ matrix.target_gnu }}
          mv target/${{ matrix.target_gnu }}/debian/*.deb dist/

          # rpm
          cargo generate-rpm --target ${{ matrix.target_gnu }} -o dist/
                      
      - name: Upload Artifacts (Linux)
        uses: actions/upload-artifact@v4
        with:
          name: linux-${{ matrix.arch }}
          path: dist/*

      - name: Upload GUI Binary (Linux)
        uses: actions/upload-artifact@v4
        with:
          name: linux-gui-bin-${{ matrix.arch }}
          path: target/${{ matrix.target_gnu }}/release/fontsync
            
  windows:
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x86_64
            target: x86_64-pc-windows-msvc
            artifact: fontsync-windows-x86_64.zip
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Build release
        run: cargo build --release --target ${{ matrix.target }}

      - name: Package (Windows)
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          Copy-Item -Path target\${{ matrix.target }}\release\fontsync.exe -Destination dist\fontsync.exe
          Compress-Archive -Path dist\fontsync.exe -DestinationPath dist\${{ matrix.artifact }}

      - name: Upload Artifacts (Windows)
        uses: actions/upload-artifact@v4
        with:
          name: windows-${{ matrix.arch }}
          path: dist/${{ matrix.artifact }}

  publish:
    runs-on: ubuntu-latest
    needs: [linux, windows, archlinux]
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Upload Release Assets
        uses: softprops/action-gh-release@v2
        with:
          files: dist/**/*

  archlinux:
    runs-on: ubuntu-22.04
    container: archlinux:latest
    needs: linux
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system dependencies (Arch)
        run: |
          pacman -Sy --noconfirm base-devel zstd dbus pkgconf \
            libx11 libxext libxinerama libxcursor libxrender libxfixes libxft \
            fontconfig pango cairo glib2 musl patchelf desktop-file-utils \
            fakeroot fuse2

      - name: Download GUI Binary (Linux)
        uses: actions/download-artifact@v4
        with:
          name: linux-gui-bin-amd64
          path: packaging/arch

      - name: Package (Arch)
        shell: bash
        run: |
          PKGVER="${GITHUB_REF_NAME#v}"
          PKG_SHA256="$(sha256sum packaging/arch/fontsync | awk '{print $1}')"
          sed -e "s/__PKGVER__/${PKGVER}/" -e "s/__PKG_SHA256__/${PKG_SHA256}/" packaging/arch/PKGBUILD.in > packaging/arch/PKGBUILD
          useradd -m build
          chown -R build:build packaging/arch
          su build -c 'cd packaging/arch && makepkg -f --nodeps --noconfirm'

      - name: Upload Artifacts (Arch)
        uses: actions/upload-artifact@v4
        with:
          name: archlinux-x86_64
          path: packaging/arch/*.pkg.tar.zst
